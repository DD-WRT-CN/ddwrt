<!DOCTYPE html>
<html>
    <head>
        <title>Asterisk Project : Conference Bridge Messaging</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Asterisk Project</a></span>
                            </li>
                                                    <li>
                                <span><a href="Home_4259930.html">Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Deployment_27200188.html">Deployment</a></span>
                            </li>
                                                    <li>
                                <span><a href="Enhanced-Messaging_40818220.html">Enhanced Messaging</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Asterisk Project : Conference Bridge Messaging
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
    
            Created by <span class='author'> Richard Mudgett</span>, last modified by <span class='editor'> George Joseph</span> on Sep 12, 2018
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <div class="contentLayout2">
<div class="columnLayout two-right-sidebar" data-layout="two-right-sidebar">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="ConferenceBridgeMessaging-Overview">Overview</h1><p>Since Asterisk 13.22.0 and 15.5.0, the ConfBridge application is optionally able to send enhanced messages to participants about the bridge itself and the participants in the bridge.</p><h1 id="ConferenceBridgeMessaging-Whatdataisavailable?">What data is available?</h1><p>The AMI events generated by the ConfBridge application give you an idea of what data is available.  You can take a look at the ConfBridge manager events pages of your version of Asterisk.  However, AMI events are typically sent only to trusted parties so not all of the information in each event is available via Enhanced Messaging.  Conversely, there is data available via Enhanced Messaging that is useful for a conference application but not included in the AMI events.  One of the most useful of these is a ConfbridgeWelcome event that participants receive when they join a conference.  It contains a list of all the other participants currently in the conference.</p></div>
</div>
<div class="cell aside" data-type="aside">
<div class="innerCell">
<p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1582303119115 {padding: 0px;}
div.rbtoc1582303119115 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1582303119115 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1582303119115'>
<ul class='toc-indentation'>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Overview'>Overview</a></li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Whatdataisavailable?'>What data is available?</a></li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Whatcouldyoudowiththedata?'>What could you do with the data?</a></li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Messageexamples'>Message examples</a></li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Gettingeventssenttoyourwebapplication'>Getting events sent to your web application</a>
<ul class='toc-indentation'>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-InAsterisk'>In Asterisk</a></li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Inthebrowser'>In the browser</a></li>
</ul>
</li>
<li><a href='https://wiki.asterisk.org/wiki/display/AST/Conference+Bridge+Messaging#ConferenceBridgeMessaging-Puttingitalltogether'>Putting it all together</a></li>
</ul>
</div></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="ConferenceBridgeMessaging-Whatcouldyoudowiththedata?">What could you do with the data?</h1><p>These are just a few examples.</p><ul><li>For your chat application, show a list of all the current conference participants.</li><li>Overlay participant nicknames on their video windows.</li><li>Add mute/unmute indicators.</li><li>Highlight the video element of the current speaker.</li></ul><h1 id="ConferenceBridgeMessaging-Messageexamples">Message examples</h1><p>When Bob joins the ConfBridge he receives the ConfbridgeWelcome event:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Confluence; brush: java; gutter: false" style="font-size:12px;">{
  &quot;type&quot;: &quot;ConfbridgeWelcome&quot;,
  &quot;timestamp&quot;: &quot;2018-08-17T08:33:30.806-0600&quot;,
  &quot;bridge&quot;: {
    &quot;id&quot;: &quot;75539107-a8fb-47fd-9b6a-7a9391ce011a&quot;,
    &quot;name&quot;: &quot;MYCONF&quot;,
    &quot;video_mode&quot;: &quot;sfu&quot;
  },
  &quot;channels&quot;: [
    {
      &quot;id&quot;: &quot;confserver-1534516369.15&quot;,
      &quot;name&quot;: &quot;PJSIP/trunk1-00000003&quot;,
      &quot;state&quot;: &quot;Up&quot;,
      &quot;caller&quot;: {
        &quot;name&quot;: &quot;Alice&quot;,
        &quot;number&quot;: &quot;alicewonderland&quot;
      },
      &quot;creationtime&quot;: &quot;2018-08-17T08:32:49.741-0600&quot;,
      &quot;language&quot;: &quot;en&quot;,
      &quot;admin&quot;: true,
      &quot;muted&quot;: false
    },
    {
      &quot;id&quot;: &quot;confserver-1534516410.21&quot;,
      &quot;name&quot;: &quot;PJSIP/trunk1-00000000&quot;,
      &quot;state&quot;: &quot;Up&quot;,
      &quot;caller&quot;: {
        &quot;name&quot;: &quot;Bob&quot;,
        &quot;number&quot;: &quot;robert&quot;
      },
      &quot;creationtime&quot;: &quot;2018-08-17T08:17:36.353-0600&quot;,
      &quot;language&quot;: &quot;en&quot;,
      &quot;admin&quot;: true,
      &quot;muted&quot;: false
    }
  ]
}</pre>
</div></div><p>In the ConfbridgeWelcome event, the &quot;channels&quot; arrays contains all of the channels currently in the bridge, including Bob himself.  In this case, Alice was already in the conference when Bob joined.</p><p>The ConfbridgeJoin event is sent to all other participants when someone joins the conference.  In this case Bob is joining the conference.  If the &quot;echo_events&quot; option is enabled, Bob can also receive his join message when he joins.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Confluence; brush: java; gutter: false" style="font-size:12px;">{
  &quot;type&quot;: &quot;ConfbridgeJoin&quot;,
  &quot;timestamp&quot;: &quot;2018-08-17T08:17:39.578-0600&quot;,
  &quot;bridge&quot;: {
    &quot;id&quot;: &quot;ea65ab81-179a-47eb-b55e-be716a2c7c80&quot;,
    &quot;name&quot;: &quot;MYCONF&quot;,
    &quot;video_mode&quot;: &quot;sfu&quot;
  },
  &quot;channels&quot;: [
    {
      &quot;id&quot;: &quot;confserver-1534516410.21&quot;,
      &quot;name&quot;: &quot;PJSIP/trunk1-00000000&quot;,
      &quot;state&quot;: &quot;Up&quot;,
      &quot;caller&quot;: {
        &quot;name&quot;: &quot;Bob&quot;,
        &quot;number&quot;: &quot;robert&quot;
      },
      &quot;creationtime&quot;: &quot;2018-08-17T08:17:36.353-0600&quot;,
      &quot;language&quot;: &quot;en&quot;,
      &quot;admin&quot;: true,
      &quot;muted&quot;: false
    }
  ]
}</pre>
</div></div><p>Since this is an event related to a specific participant, the &quot;channels&quot; array just has Bob's channel in it.</p><p>Most of the other ConfBridge events have the same contents.  They are ConfbridgeJoin, ConfbridgeLeave, ConfbridgeRecord, ConfbridgeStopRecord, ConfbridgeMute, ConfbridgeUnmute, ConfbridgeWelcome.  If your bridge has the &quot;talk_detection_events&quot; option set to &quot;yes&quot;, participants will also receive ConfbridgeTalking events containing a &quot;talking_status&quot; indicator in place of the &quot;muted&quot; parameter appearing in most of the other events.</p><p>If you are familiar with the ConfBridge AMI events, you will notice that the ConfbridgeStart and ConfbridgeEnd events are missing.  That is because they do not make much sense in this context.  At the time they are generated, there are no participants to receive them.</p><h1 id="ConferenceBridgeMessaging-Gettingeventssenttoyourwebapplication">Getting events sent to your web application</h1><h2 id="ConferenceBridgeMessaging-InAsterisk">In Asterisk</h2><p>Start by adding a few parameters to your user and bridge profiles in confbridge.conf:</p><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>[default_user]
type=user
send_events=yes ; If events are enabled for this bridge and this option is
                ; set, users will receive events like join, leave, talking,
                ; etc. via text messages.  For users accessing the bridge
                ; via chan_pjsip, this means in-dialog MESSAGE requests.
                ; This is most useful for WebRTC participants where the
                ; browser application can use the messages to alter the user
                ; interface.
echo_events=yes ; If events are enabled for this user and this option is set,
                ; the user will receive events they trigger, talking, mute, etc.
                ; If not set, they will not receive their own events.
[default_bridge]
type=bridge
enable_events=yes  ; If enabled, recipients who joined the bridge via a channel driver
                   ; that supports Enhanced Messaging (currently only chan_pjsip) will
                   ; receive in-dialog messages containing a JSON body describing the
                   ; event.  The Content-Type header will be
                   ; &quot;application/x-asterisk-confbridge-event+json&quot;.
                   ; This feature must also be enabled in user profiles.</pre>
</div></div><p>Of course, your configuration will be different but those are the parameters that need to be set.</p>    <div class="aui-message problem shadowed information-macro">
                            <span class="aui-icon icon-problem">Icon</span>
                <div class="message-content">
                            <p>If a user connects to the bridge via a DAHDI channel or some other non-SIP based channel, they may receive messages in another format, like SMS, which is probably not a good idea.  To prevent this, you may want to use two different user profiles, one with events enabled and one without.  You could then do some simple dialplan logic to look at the incoming channel technology and call ConfBridge() with the appropriate user profile.</p>
                    </div>
    </div>
<h2 id="ConferenceBridgeMessaging-Inthebrowser">In the browser</h2><p>You use the same mechanism as shown in <a href="https://wiki.asterisk.org/wiki/display/AST/Conference+Participant+Messaging" rel="nofollow">Conference Participant Messaging</a>.  The only difference will be that the message Content-Type will be &quot;application/x-asterisk-confbridge-event+json&quot;.  The message bodies will be JSON events as shown above.</p><h1 id="ConferenceBridgeMessaging-Puttingitalltogether">Putting it all together</h1><p>One of the possible uses for the events mentioned above was overlaying a participant's nickname on their video window.  Here is a hint on how you could do that.</p><p>If you look at the events you will notice that every channel specifies an &quot;id&quot; field which is the Asterisk channel's unique id.  When you receive ConfbridgeJoin or ConfbridgeWelcome events, save the event in a hashmap keyed by that id.  When you receive a new video stream, which you can intercept by adding an &quot;sdp&quot; handler to your JsSip RTCSession, look at the sdp and look for the &quot;a:label&quot; and &quot;a:msid&quot; attributes in each video stream.  The &quot;a:label&quot; will be the participant's channel id as specified in the events and the &quot;a:msid&quot; will be available in the video element WebRTC creates.  Now, just create another hashmap that cross references the two and when you draw your video elements, you can grab the msid from it and then get the corresponding participant from the hashmaps.</p></div>
</div>
</div>
</div>
                    </div>

                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 21, 2020 09:38</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
